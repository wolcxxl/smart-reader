<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Smart Reader</title>
    
    <!-- PWA Settings for iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Smart Reader">
    <meta name="theme-color" content="#2d2d30">

    <!-- Auto-Generated Icon (SVG) -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512' fill='%23007acc'><path d='M464 64H48C21.5 64 0 85.5 0 112v288c0 26.5 21.5 48 48 48h416c26.5 0 48-21.5 48-48V112c0-26.5-21.5-48-48-48zM240 384H64V128h176v256zm192 0H272V128h160v256z'/></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512' style='background:%232d2d30' fill='%23007acc'><path d='M464 64H48C21.5 64 0 85.5 0 112v288c0 26.5 21.5 48 48 48h416c26.5 0 48-21.5 48-48V112c0-26.5-21.5-48-48-48zM240 384H64V128h176v256zm192 0H272V128h160v256z'/></svg>">

    <!-- Web App Manifest (Data URI for Single File) -->
    <link rel="manifest" id="manifest-placeholder">

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs@0.3.93/dist/epub.min.js"></script>

    <style>
        :root {
            --bg: #1e1e1e;
            --panel: #252526;
            --text: #d4d4d4;
            --accent: #007acc;
            --border: #3e3e42;
            --highlight: #2d333b;
            --success: #4ec9b0;
            --danger: #f14c4c;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            height: 100dvh; /* Mobile viewport fix */
            display: flex;
            flex-direction: column;
            overflow: hidden;
            touch-action: none;
            padding-top: env(safe-area-inset-top); /* Notch support */
        }

        /* Header */
        header {
            height: 50px;
            background: #2d2d30;
            display: flex;
            align-items: center;
            border-bottom: 1px solid var(--border);
            padding: 0 10px;
            gap: 10px;
            flex-shrink: 0;
        }

        .group { display: flex; align-items: center; gap: 5px; }

        .file-wrapper {
            position: relative; overflow: hidden; background: #444; padding: 6px 12px;
            border-radius: 6px; cursor: pointer; display: flex; align-items: center;
        }
        .file-wrapper input[type=file] {
            position: absolute; left: 0; top: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer;
        }
        .file-label-text { font-size: 0.9em; font-weight: 500; pointer-events: none; color: #fff; }

        select {
            background: #3e3e42; color: white; border: 1px solid #555;
            padding: 5px; border-radius: 6px; cursor: pointer; font-size: 14px;
        }

        button {
            background: var(--accent); color: white; border: none;
            padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 14px;
            display: flex; align-items: center; justify-content: center;
        }
        button:disabled { background: #333; color: #666; }
        button.icon-btn { width: 40px; background: #444; font-size: 18px; }

        /* Progress Bar */
        #progressBar {
            position: fixed; top: 0; left: 0; height: 4px; background: #00ff00; width: 0%; 
            z-index: 10001; transition: width 0.2s;
        }

        /* Main Container */
        #container {
            display: flex; flex: 1; width: 100%; height: 100%;
            overflow: hidden; flex-direction: column;
        }

        .panel {
            flex: 1; display: flex; flex-direction: column; overflow: hidden;
            min-height: 50px; min-width: 50px; position: relative;
        }

        .panel-head {
            background: #202020; padding: 0 15px; height: 40px;
            font-size: 0.8em; color: #aaa; font-weight: 600; letter-spacing: 0.5px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #333; flex-shrink: 0; text-transform: uppercase;
        }

        .trans-controls { display: flex; gap: 8px; }
        .btn-start { background: var(--success); color: #111; padding: 4px 10px; font-size: 11px; }
        .btn-stop { background: var(--danger); padding: 4px 10px; font-size: 11px; }

        .content-area {
            flex: 1; overflow-y: auto; padding: 20px; font-size: 18px; line-height: 1.6;
            -webkit-overflow-scrolling: touch; touch-action: pan-y;
        }

        /* Resizer */
        .resizer {
            background: #111; z-index: 50; display: flex; justify-content: center; align-items: center;
            flex-shrink: 0; user-select: none; touch-action: none;
        }
        .resizer::after { content: ""; width: 40px; height: 4px; background: #444; border-radius: 2px; }
        .resizer.active, .resizer:hover { background: #333; }
        .resizer.active::after { background: var(--accent); }

        /* Content Text */
        .orig-p { margin-bottom: 1.5em; text-align: justify; }
        .trans-p {
            margin-bottom: 1.5em; padding: 12px; border: 1px solid #444; border-radius: 8px;
            cursor: pointer; position: relative; background: #232323;
        }
        .trans-p:active { background: #333; }
        .trans-p.translated { 
            border-color: transparent; background: transparent; cursor: text; padding: 0 0 0 10px;
            border-left: 3px solid var(--accent); border-radius: 0;
        }
        .trans-p.current { border-color: var(--success); background: rgba(78, 201, 176, 0.1); }
        .hint { font-size: 0.75em; color: var(--accent); display: block; margin-bottom: 4px; opacity: 0.8; }
        
        .word { cursor: pointer; border-bottom: 1px dotted transparent; }
        .word:active { background: rgba(255,215,0, 0.3); color: white; }
        .word.active { background: var(--accent); color: white; border-radius: 2px;}

        /* Tooltip Popup */
        #tooltip {
            position: absolute; display: none;
            background: rgba(40, 40, 40, 0.95); border: 1px solid #555;
            padding: 12px; border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            z-index: 9999; max-width: 280px; min-width: 140px; text-align: center;
            backdrop-filter: blur(10px);
            animation: fadeUp 0.15s ease-out;
        }
        @keyframes fadeUp { from{opacity:0; transform:translateY(5px)} to{opacity:1; transform:translateY(0)} }
        
        #tooltip .t-word { font-weight: 700; font-size: 1.1em; color: white; margin-bottom: 4px; display:block; }
        #tooltip .t-trans { font-size: 1.1em; color: #ddd; margin-bottom: 10px; display:block; }
        .close-tip {
            width: 100%; padding: 6px; background: rgba(255,255,255,0.1); border: none; 
            color: #ccc; cursor: pointer; border-radius: 6px; font-size: 12px;
        }

        /* Status & Loader */
        #statusLine {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: #2d2d30; color: #888; font-size: 11px;
            padding: 4px 10px; z-index: 10000; text-align: center;
            border-top: 1px solid #333;
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        #loader {
            position: fixed; inset: 0; background: rgba(0,0,0,0.9);
            display: none; justify-content: center; align-items: center;
            color: white; z-index: 2000; flex-direction: column;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #444; border-top: 4px solid var(--accent);
            border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

<div id="progressBar"></div>

<header>
    <div class="file-wrapper">
        <span class="file-label-text">üìÇ –û—Ç–∫—Ä—ã—Ç—å</span>
        <input type="file" id="fileInput">
    </div>

    <div class="group">
        <select id="srcLang"><option value="de">DE</option><option value="en">EN</option><option value="fr">FR</option><option value="auto">Auto</option></select>
        <span style="color:#666">‚Üí</span>
        <select id="tgtLang"><option value="ru">RU</option><option value="en">EN</option><option value="uk">UK</option></select>
    </div>

    <button id="layoutBtn" class="icon-btn" title="–í–∏–¥">‚¨ç</button>

    <div class="group" id="controls" style="display:none; margin-left:auto;">
        <button id="prevBtn">‚Üê</button>
        <select id="chapterSelect" style="max-width:100px"></select>
        <button id="nextBtn">‚Üí</button>
    </div>
</header>

<div id="container">
    <div id="panel1" class="panel">
        <div class="panel-head">–û—Ä–∏–≥–∏–Ω–∞–ª</div>
        <div id="origPanel" class="content-area">
            <div style="text-align:center; margin-top:25vh; color:#666; padding:20px;">
                <h3>Smart Reader PWA</h3>
                <p>–ù–∞–∂–º–∏—Ç–µ "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è" ‚Üí "–ù–∞ —ç–∫—Ä–∞–Ω –î–æ–º–æ–π", —á—Ç–æ–±—ã —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–∞–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.</p>
                <p>–ü–æ–¥–¥–µ—Ä–∂–∫–∞ FB2, EPUB, PDF.</p>
            </div>
        </div>
    </div>

    <div id="resizer" class="resizer" style="height: 16px; width: 100%; cursor: row-resize;"></div>

    <div id="panel2" class="panel">
        <div class="panel-head">
            <span>–ü–µ—Ä–µ–≤–æ–¥</span>
            <div class="trans-controls">
                <button id="btnStart" class="btn-start">‚ñ∂ –°—Ç–∞—Ä—Ç</button>
                <button id="btnStop" class="btn-stop" disabled>‚ñ† –°—Ç–æ–ø</button>
            </div>
        </div>
        <div id="transPanel" class="content-area"></div>
    </div>
</div>

<div id="tooltip"></div>
<div id="statusLine">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>
<div id="loader"><div class="spinner"></div><div id="loaderLog">–ó–∞–≥—Ä—É–∑–∫–∞...</div></div>

<script>
    // --- GENERATE MANIFEST ON THE FLY ---
    const manifest = {
        name: "Smart Reader",
        short_name: "Reader",
        start_url: ".",
        display: "standalone",
        background_color: "#1e1e1e",
        theme_color: "#2d2d30",
        icons: [{
            src: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512' fill='%23007acc'><rect width='512' height='512' fill='%232d2d30'/><path d='M464 64H48C21.5 64 0 85.5 0 112v288c0 26.5 21.5 48 48 48h416c26.5 0 48-21.5 48-48V112c0-26.5-21.5-48-48-48zM240 384H64V128h176v256zm192 0H272V128h160v256z'/></svg>",
            sizes: "512x512",
            type: "image/svg+xml"
        }]
    };
    const stringManifest = JSON.stringify(manifest);
    const blobManifest = new Blob([stringManifest], {type: 'application/json'});
    document.getElementById('manifest-placeholder').setAttribute('href', URL.createObjectURL(blobManifest));

    // --- CONFIG ---
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
    
    // --- UI REFERENCES ---
    const ui = {
        file: document.getElementById('fileInput'),
        orig: document.getElementById('origPanel'),
        trans: document.getElementById('transPanel'),
        controls: document.getElementById('controls'),
        chapSel: document.getElementById('chapterSelect'),
        loader: document.getElementById('loader'),
        log: document.getElementById('loaderLog'),
        status: document.getElementById('statusLine'),
        tooltip: document.getElementById('tooltip'),
        src: document.getElementById('srcLang'),
        tgt: document.getElementById('tgtLang'),
        container: document.getElementById('container'),
        panel1: document.getElementById('panel1'),
        panel2: document.getElementById('panel2'),
        resizer: document.getElementById('resizer'),
        layoutBtn: document.getElementById('layoutBtn'),
        bar: document.getElementById('progressBar'),
        btnStart: document.getElementById('btnStart'),
        btnStop: document.getElementById('btnStop')
    };

    let book, spine, currentIdx = 0, isTranslating = false, fb2Sections = [];
    
    const setStatus = (msg) => ui.status.innerText = msg;
    const showLoad = (msg) => { ui.log.innerText = msg || "–ó–∞–≥—Ä—É–∑–∫–∞..."; ui.loader.style.display = 'flex'; };
    const hideLoad = () => ui.loader.style.display = 'none';
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));

    window.onload = () => setStatus("PWA Reader –≥–æ—Ç–æ–≤. –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª.");

    // --- LAYOUT ---
    let isVertical = true;
    function updateLayout() {
        if(isVertical) {
            ui.container.style.flexDirection = 'column';
            ui.resizer.style.width = '100%'; ui.resizer.style.height = '16px'; ui.resizer.style.cursor = 'row-resize';
            ui.layoutBtn.innerText = '‚¨ç';
        } else {
            ui.container.style.flexDirection = 'row';
            ui.resizer.style.width = '16px'; ui.resizer.style.height = '100%'; ui.resizer.style.cursor = 'col-resize';
            ui.layoutBtn.innerText = '‚¨Ñ';
        }
        ui.panel1.style.flex = '1'; ui.panel2.style.flex = '1';
    }
    ui.layoutBtn.onclick = () => { isVertical = !isVertical; updateLayout(); };

    // --- RESIZER ---
    let isResizing = false;
    const startR = (e) => { isResizing=true; if(e.type==='touchstart')e.preventDefault(); ui.resizer.classList.add('active'); };
    const stopR = () => { isResizing=false; ui.resizer.classList.remove('active'); };
    const doR = (e) => {
        if(!isResizing) return;
        let cy = e.type.startsWith('touch') ? e.touches[0].clientY : e.clientY;
        let cx = e.type.startsWith('touch') ? e.touches[0].clientX : e.clientX;
        const r = ui.container.getBoundingClientRect();
        if(isVertical) {
            let pct = ((cy - r.top) / r.height) * 100;
            if(pct>10 && pct<90) { ui.panel1.style.flex = `0 0 ${pct}%`; ui.panel2.style.flex = '1'; }
        } else {
            let pct = ((cx - r.left) / r.width) * 100;
            if(pct>10 && pct<90) { ui.panel1.style.flex = `0 0 ${pct}%`; ui.panel2.style.flex = '1'; }
        }
    };
    ui.resizer.addEventListener('mousedown', startR); document.addEventListener('mouseup', stopR); document.addEventListener('mousemove', doR);
    ui.resizer.addEventListener('touchstart', startR); document.addEventListener('touchend', stopR); document.addEventListener('touchmove', doR);

    // --- FILES ---
    ui.file.onclick = () => { ui.file.value = null; };
    ui.file.addEventListener('change', async (e) => {
        const f = e.target.files[0];
        if(!f) return;
        
        setStatus(`–ó–∞–≥—Ä—É–∑–∫–∞: ${f.name}...`);
        showLoad("–û—Ç–∫—Ä—ã—Ç–∏–µ...");
        await sleep(50); // UI refresh

        try {
            ui.controls.style.display = 'none';
            const n = f.name.toLowerCase();
            
            if(n.endsWith('.zip')) await loadZip(f);
            else if(n.endsWith('.fb2')) await loadFb2(f);
            else if(n.endsWith('.epub')) await loadEpub(f);
            else if(n.endsWith('.pdf')) await loadPdf(f);
            else render(await f.text());
            
            setStatus(f.name);
        } catch(err) {
            alert(err.message); setStatus("–û—à–∏–±–∫–∞");
        } finally { hideLoad(); }
    });

    // --- READERS ---
    async function loadZip(f) {
        showLoad("Unzip...");
        const z = new JSZip();
        const c = await z.loadAsync(f);
        let target = null, tName = "";
        for(let n in c.files) {
            if(n.match(/\.(fb2|epub|txt)$/i)) { target = c.files[n]; tName = n; break; }
        }
        if(!target) throw new Error("–ö–Ω–∏–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –∞—Ä—Ö–∏–≤–µ");
        setStatus(`–†–∞—Å–ø–∞–∫–æ–≤–∞–Ω–æ: ${tName}`);
        
        if(tName.endsWith('.epub')) await loadEpub(new File([await target.async("blob")], "b.epub"));
        else if(tName.endsWith('.fb2')) processFb2(await target.async("string"));
        else render(await target.async("string"));
    }

    async function loadFb2(f) { showLoad("FB2..."); processFb2(await f.text()); }
    function processFb2(txt) {
        const doc = new DOMParser().parseFromString(txt, "text/xml");
        const body = doc.querySelector("body");
        if(!body) throw new Error("Bad FB2");
        const secs = Array.from(body.querySelectorAll("section"));
        fb2Sections = [];
        ui.chapSel.innerHTML = '';
        ui.controls.style.display = 'flex';
        
        if(secs.length > 0) {
            secs.forEach((s, i) => {
                let t = s.querySelector("title")?.textContent || `–ì–ª–∞–≤–∞ ${i+1}`;
                if(t.length>30) t = t.substring(0,30)+"...";
                fb2Sections.push(s);
                ui.chapSel.add(new Option(t, i));
            });
            loadFb2Chap(0);
        } else {
            fb2Sections = [body];
            ui.chapSel.add(new Option("–¢–µ–∫—Å—Ç", 0));
            loadFb2Chap(0);
        }
    }
    function loadFb2Chap(i) {
        resetTrans();
        currentIdx = i; ui.chapSel.value = i;
        const s = fb2Sections[i];
        let txt = "";
        const ps = s.querySelectorAll("p,v,subtitle");
        if(ps.length>0) ps.forEach(p => txt += p.textContent + "\n\n");
        else txt = s.textContent;
        render(txt);
    }

    async function loadEpub(f) {
        fb2Sections = [];
        book = ePub(await f.arrayBuffer());
        await book.ready;
        spine = book.spine.spineItems;
        ui.chapSel.innerHTML = '';
        spine.forEach((_,i) => ui.chapSel.add(new Option(`–ì–ª–∞–≤–∞ ${i+1}`, i)));
        ui.controls.style.display = 'flex';
        loadEpubChap(0);
    }
    async function loadEpubChap(i) {
        resetTrans();
        currentIdx = i; ui.chapSel.value = i;
        showLoad(`–ì–ª–∞–≤–∞ ${i+1}`);
        try {
            const doc = await spine[i].load(book.load.bind(book));
            let h = doc.body?.innerHTML || new XMLSerializer().serializeToString(doc);
            let t = h.replace(/<(br|div|p|h\d)[^>]*>/gi, '\n').replace(/<[^>]+>/g, '').replace(/&nbsp;/g,' ').replace(/\n\s*\n/g, '\n\n');
            render(t);
        } catch(e) { render("Error: "+e.message); }
        finally { hideLoad(); }
    }

    async function loadPdf(f) {
        ui.controls.style.display = 'none';
        showLoad("PDF...");
        const pdf = await pdfjsLib.getDocument(await f.arrayBuffer()).promise;
        let t = "";
        for(let i=1; i<=Math.min(pdf.numPages, 30); i++) {
            showLoad(`PDF ${i}/${pdf.numPages}`);
            const p = await pdf.getPage(i);
            const c = await p.getTextContent();
            t += c.items.map(s=>s.str).join(' ') + "\n\n";
        }
        render(t);
    }

    // --- RENDER ---
    function render(txt) {
        ui.orig.innerHTML = ''; ui.trans.innerHTML = ''; ui.orig.scrollTop = 0;
        const arr = txt.split(/\n\s*\n/).filter(x => x.trim().length > 1);
        if(!arr.length) { ui.orig.innerHTML = "<p>–ü—É—Å—Ç–æ</p>"; return; }

        const f1 = document.createDocumentFragment();
        const f2 = document.createDocumentFragment();

        arr.forEach(s => {
            const d1 = document.createElement('div'); d1.className = 'orig-p';
            d1.innerHTML = s.replace(/([a-zA-Z–∞-—è–ê-–Ø0-9\u00C0-\u00FF'-]+)/g, '<span class="word" onclick="clickWord(event,this)">$1</span>');
            f1.appendChild(d1);

            const d2 = document.createElement('div'); d2.className = 'trans-p'; 
            d2.dataset.text = s; d2.innerHTML = `<span class="hint">–ü–µ—Ä–µ–≤–µ—Å—Ç–∏</span>${s}`;
            d2.onclick = () => doTrans(d2);
            f2.appendChild(d2);
        });
        ui.orig.appendChild(f1); ui.trans.appendChild(f2);
        setupSync();
    }

    // --- TRANS ---
    async function api(txt) {
        const u = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=${ui.src.value}&tl=${ui.tgt.value}&dt=t&q=${encodeURIComponent(txt)}`;
        const r = await fetch(u);
        const d = await r.json();
        return d[0].map(x=>x[0]).join('');
    }

    async function doTrans(el) {
        if(el.classList.contains('translated') || el.classList.contains('loading')) return;
        el.classList.add('loading'); el.classList.add('current');
        try {
            const t = await api(el.dataset.text);
            el.innerHTML = t; el.classList.add('translated');
        } catch { el.classList.add('error'); el.innerHTML = "–û—à–∏–±–∫–∞"; }
        finally { el.classList.remove('loading', 'current'); }
    }

    function resetTrans() { isTranslating=false; ui.btnStart.disabled=false; ui.btnStop.disabled=true; }

    ui.btnStart.onclick = async () => {
        if(isTranslating) return;
        const els = Array.from(document.querySelectorAll('.trans-p'));
        if(!els.length) return;
        isTranslating = true; ui.btnStart.disabled = true; ui.btnStop.disabled = false;
        
        // Find first visible
        let idx = els.findIndex(e => e.offsetTop + e.clientHeight > ui.trans.scrollTop);
        if(idx<0) idx=0;

        for(let i=idx; i<els.length; i++) {
            if(!isTranslating) break;
            if(!els[i].classList.contains('translated')) {
                await doTrans(els[i]);
                ui.bar.style.width = `${((i+1)/els.length)*100}%`;
                await sleep(500);
            }
        }
        ui.bar.style.width = '0%'; resetTrans();
    };
    ui.btnStop.onclick = resetTrans;

    window.clickWord = async (e, el) => {
        e.stopPropagation();
        document.querySelectorAll('.word.active').forEach(x=>x.classList.remove('active'));
        el.classList.add('active');
        
        const w = el.innerText;
        const r = el.getBoundingClientRect();
        ui.tooltip.style.display = 'block';
        ui.tooltip.style.top = (r.bottom + 5) + 'px';
        let left = r.left;
        if(left + 160 > window.innerWidth) left = window.innerWidth - 170;
        ui.tooltip.style.left = left + 'px';
        
        ui.tooltip.innerHTML = `<span class="t-word">${w}</span><span class="t-trans">...</span>`;
        try {
            const t = await api(w);
            ui.tooltip.innerHTML = `<span class="t-word">${w}</span><span class="t-trans">${t}</span><button class="close-tip" onclick="document.getElementById('tooltip').style.display='none'">X</button>`;
        } catch { ui.tooltip.innerHTML = "Error"; }
    };

    document.addEventListener('click', (e) => {
        if(!e.target.classList.contains('word') && !ui.tooltip.contains(e.target)) {
            ui.tooltip.style.display = 'none';
            document.querySelectorAll('.word.active').forEach(x=>x.classList.remove('active'));
        }
    });

    function setupSync() {
        let l=0, r=0;
        ui.orig.onscroll = () => { if(!l){r=1; s(ui.orig, ui.trans);} l=0; };
        ui.trans.onscroll = () => { if(!r){l=1; s(ui.trans, ui.orig);} r=0; };
    }
    const s = (a, b) => { b.scrollTop = (a.scrollTop / (a.scrollHeight - a.clientHeight)) * (b.scrollHeight - b.clientHeight); }

    function loadAny(i) {
        if(fb2Sections.length) loadFb2Chap(i);
        else if(spine && spine.length) loadEpubChap(i);
    }
    ui.chapSel.onchange = (e) => loadAny(parseInt(e.target.value));
    document.getElementById('prevBtn').onclick = () => loadAny(currentIdx-1);
    document.getElementById('nextBtn').onclick = () => loadAny(currentIdx+1);

    updateLayout();
</script>
</body>
</html>
