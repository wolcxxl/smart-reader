<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Smart Reader v46 (Fix Selection)</title>
    
    <!-- PWA -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#252526">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512' fill='%23007acc'><path d='M464 64H48C21.5 64 0 85.5 0 112v288c0 26.5 21.5 48 48 48h416c26.5 0 48-21.5 48-48V112c0-26.5-21.5-48-48-48zM240 384H64V128h176v256zm192 0H272V128h160v256z'/></svg>">

    <!-- Libs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs@0.3.93/dist/epub.min.js"></script>

    <style>
        :root {
            --bg: #1e1e1e;
            --text: #d4d4d4;
            --accent: #007acc;
            --border: #3e3e42;
            --highlight: #2d333b;
            --success: #4ec9b0;
            --danger: #f14c4c;
            --font-size: 18px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            touch-action: pan-y;
        }

        /* --- HEADER --- */
        #menu-bar {
            height: 30px;
            background: #2d2d30;
            display: flex;
            justify-content: center;
            align-items: center;
            border-bottom: 1px solid #444;
            flex-shrink: 0;
            z-index: 101;
            position: relative;
        }

        #menu-toggle {
            background: #444;
            color: #fff;
            border: 1px solid #555;
            border-top: none;
            border-radius: 0 0 10px 10px;
            padding: 0 30px;
            height: 24px;
            line-height: 24px;
            cursor: pointer;
            font-size: 20px;
            margin-top: -1px; 
        }

        #settings-panel {
            background: #252526;
            border-bottom: 1px solid var(--border);
            overflow: hidden;
            max-height: 0;
            transition: max-height 0.3s ease-out;
            flex-shrink: 0;
            z-index: 100;
        }

        #settings-panel.open {
            max-height: 120px;
        }

        .menu-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 10px;
            gap: 10px;
        }

        .group { display: flex; align-items: center; gap: 8px; }

        /* Controls */
        .file-wrapper {
            position: relative; overflow: hidden; background: #007acc; color: white;
            padding: 0 12px; border-radius: 4px; cursor: pointer; display: flex; align-items: center;
            height: 30px; font-size: 13px; white-space: nowrap;
        }
        .file-wrapper input { position: absolute; left: 0; top: 0; width: 100%; height: 100%; opacity: 0; }

        select {
            background: #3e3e42; color: white; border: 1px solid #555;
            padding: 0 5px; border-radius: 4px; font-size: 13px; height: 30px;
        }

        button {
            background: #444; color: white; border: none;
            padding: 0 12px; border-radius: 4px; cursor: pointer; font-size: 13px; height: 30px;
            display: flex; align-items: center; justify-content: center;
        }
        button:disabled { opacity: 0.5; pointer-events: none; }
        button.active-state { background: #fff; color: #000; }
        .icon-btn { width: 34px; padding: 0; font-size: 16px; }

        #progressBar {
            position: fixed; top: 0; left: 0; height: 3px; background: #00ff00; width: 0%; 
            z-index: 10002; transition: width 0.2s;
        }

        /* --- CONTAINER --- */
        #container {
            display: flex; flex: 1; width: 100%; height: 100%;
            overflow: hidden; flex-direction: column;
        }

        .panel {
            flex: 1; display: flex; flex-direction: column; overflow: hidden;
            min-height: 50px; min-width: 50px; position: relative;
        }

        .panel-head {
            background: #202020; padding: 0 10px; height: 32px;
            font-size: 0.75em; color: #888; font-weight: 600; letter-spacing: 0.5px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #333; flex-shrink: 0; text-transform: uppercase;
        }

        .trans-controls { display: flex; gap: 8px; }
        .btn-tiny { padding: 0 10px; font-size: 11px; height: 22px; border-radius: 4px; }
        .btn-start { background: var(--success); color: black; font-weight: bold; }
        .btn-stop { background: var(--danger); }

        .content-area {
            flex: 1; overflow-y: auto; padding: 15px; 
            font-size: var(--font-size); line-height: 1.5;
            -webkit-overflow-scrolling: touch; touch-action: pan-y;
        }
        
        .font-serif .content-area { font-family: 'Georgia', serif; }
        .font-mono .content-area { font-family: monospace; }
        .font-bold .content-area { font-weight: 600; }

        .resizer {
            background: #111; z-index: 50; display: flex; justify-content: center; align-items: center;
            flex-shrink: 0; touch-action: none; min-height: 12px;
        }
        .resizer::after { content: ""; width: 30px; height: 3px; background: #444; border-radius: 2px; }
        .resizer.active, .resizer:hover { background: #333; }

        /* Text */
        .orig-p { margin-bottom: 1em; text-align: justify; padding: 2px; }
        
        .trans-p {
            margin-bottom: 1em; padding: 6px 18px 6px 6px;
            border: 1px solid #333; border-radius: 4px;
            cursor: pointer; position: relative; 
            background: #232323; min-height: 1.5em; text-align: justify;
        }
        .trans-marker { position: absolute; top: 4px; right: 4px; font-size: 12px; opacity: 0.5; }
        .trans-p.translated .trans-marker { display: none; }
        .trans-p.translated { 
            border-color: transparent; background: transparent; cursor: text; 
            padding: 2px; border-left: 3px solid var(--accent); padding-left: 10px; border-radius: 0;
        }
        .trans-p.current { border-color: var(--success); background: rgba(78, 201, 176, 0.1); }
        .trans-p.error { border-color: red; }

        .word { cursor: pointer; border-radius: 2px; user-select: text; -webkit-user-select: text; }
        .word:active, .word.active { background: var(--accent); color: white; }

        /* Tooltip */
        #tooltip {
            position: absolute; display: none;
            background: rgba(40, 40, 40, 0.98); border: 1px solid #555;
            padding: 12px; border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
            z-index: 9999; max-width: 280px; text-align: center;
            backdrop-filter: blur(10px);
        }
        .tt-header { display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 6px; }
        .t-word { font-weight: 700; color: #fff; font-size: 1.2em; }
        .t-tts-btn {
            background: transparent; border: 1px solid #666; color: #ccc; 
            border-radius: 50%; width: 28px; height: 28px; font-size: 14px; padding: 0;
            display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0;
        }
        .t-tts-btn.playing { background: var(--success); color: #000; border-color: var(--success); }
        .t-ipa { color: #8cf; font-size: 0.9em; display: block; margin-bottom: 2px; }
        .t-rus { color: #aaa; font-style: italic; font-size: 0.9em; display: block; margin-bottom: 8px; }
        .t-trans { color: #ddd; display:block; margin-bottom: 10px; font-size: 1.1em; line-height: 1.3; border-top: 1px solid #555; padding-top: 8px; }
        .close-tip { width: 100%; padding: 6px; background: rgba(255,255,255,0.1); border:none; color:#ccc; border-radius:4px; font-size:11px; }

        /* Action Bar */
        #selection-bar {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            z-index: 10002; display: none;
        }
        #selection-bar.visible { display: block; animation: slideUp 0.2s ease-out; }
        @keyframes slideUp { from{transform:translate(-50%, 20px); opacity:0} to{transform:translate(-50%, 0); opacity:1} }
        
        .action-btn {
            background: var(--accent); color: white; border: none;
            padding: 10px 20px; border-radius: 30px; font-weight: bold; font-size: 14px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); display: flex; align-items: center; gap: 8px;
        }

        #statusLine {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: #2d2d30; color: #888; font-size: 10px;
            padding: 2px 10px; text-align: right; z-index: 9000; pointer-events: none;
        }
        #loader {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8);
            display: none; justify-content: center; align-items: center;
            color: white; z-index: 2000; flex-direction: column;
        }
    </style>
</head>
<body>

<div id="progressBar"></div>

<!-- MENU -->
<div id="menu-bar">
    <button id="menu-toggle" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">‚ò∞</button>
</div>

<div id="settings-panel">
    <div class="menu-row">
        <div class="file-wrapper"><span>üìÇ –û—Ç–∫—Ä—ã—Ç—å</span><input type="file" id="fileInput"></div>
        <div class="group">
            <select id="fontFamily" style="width:65px">
                <option value="ui">Sans</option><option value="serif">Serif</option><option value="mono">Mono</option>
            </select>
            <select id="fontSize" style="width:50px">
                <option value="14px">14</option><option value="16px">16</option><option value="18px" selected>18</option>
                <option value="20px">20</option><option value="24px">24</option><option value="30px">30</option>
            </select>
            <button id="boldToggle" class="icon-btn" title="–ñ–∏—Ä–Ω—ã–π" style="font-weight:bold; width:30px">B</button>
        </div>
    </div>
    <div class="menu-row">
        <div class="group">
            <select id="srcLang"><option value="auto">Auto</option><option value="en">EN</option><option value="de">DE</option><option value="fr">FR</option></select>
            <span style="color:#666">‚Üí</span>
            <select id="tgtLang"><option value="ru">RU</option><option value="en">EN</option><option value="uk">UK</option></select>
        </div>
        
        <button id="layoutBtn" class="icon-btn" title="–í–∏–¥">‚¨ç</button>

        <div class="group" id="controls" style="display:none;">
            <button id="prevBtn" class="icon-btn">‚Üê</button>
            <select id="chapterSelect" style="max-width:80px"></select>
            <button id="nextBtn" class="icon-btn">‚Üí</button>
        </div>
    </div>
</div>

<div id="container">
    <div id="panel1" class="panel">
        <div class="panel-head">–û—Ä–∏–≥–∏–Ω–∞–ª</div>
        <div id="origPanel" class="content-area">
            <div style="text-align:center; margin-top:30vh; color:#555;">
                <p>–í–µ—Ä—Å–∏—è 46</p>
                <p>–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ñ—Ä–∞–∑.</p>
            </div>
        </div>
    </div>
    <div id="resizer" class="resizer" style="height: 12px; width: 100%; cursor: row-resize;"></div>
    <div id="panel2" class="panel">
        <div class="panel-head">
            <span>–ü–µ—Ä–µ–≤–æ–¥</span>
            <div class="trans-controls">
                <button id="btnStart" class="btn-tiny btn-start">‚ñ∂ –°—Ç–∞—Ä—Ç</button>
                <button id="btnStop" class="btn-tiny btn-stop" disabled>‚ñ†</button>
            </div>
        </div>
        <div id="transPanel" class="content-area"></div>
    </div>
</div>

<div id="tooltip"></div>

<!-- ACTION BAR -->
<div id="selection-bar">
    <button class="action-btn" id="translateSelBtn">üåé –ü–µ—Ä–µ–≤–µ—Å—Ç–∏ / üîä</button>
</div>

<div id="statusLine">Ready</div>
<div id="loader"><div>–ó–∞–≥—Ä—É–∑–∫–∞...</div></div>

<script>
    const manifest = {name:"Smart Reader",short_name:"Reader",start_url:".",display:"standalone",background_color:"#1e1e1e",theme_color:"#2d2d30",icons:[{src:"data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512' fill='%23007acc'><rect width='512' height='512' fill='%232d2d30'/><path d='M464 64H48C21.5 64 0 85.5 0 112v288c0 26.5 21.5 48 48 48h416c26.5 0 48-21.5 48-48V112c0-26.5-21.5-48-48-48zM240 384H64V128h176v256zm192 0H272V128h160v256z'/></svg>",sizes:"512x512",type:"image/svg+xml"}]};
    document.getElementById('manifest-placeholder')?.setAttribute('href', URL.createObjectURL(new Blob([JSON.stringify(manifest)],{type:'application/json'})));

    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
    
    const ui = {
        menuBtn: document.getElementById('menu-toggle'), settings: document.getElementById('settings-panel'),
        file: document.getElementById('fileInput'), orig: document.getElementById('origPanel'), trans: document.getElementById('transPanel'),
        controls: document.getElementById('controls'), chapSel: document.getElementById('chapterSelect'),
        loader: document.getElementById('loader'), status: document.getElementById('statusLine'), tooltip: document.getElementById('tooltip'),
        src: document.getElementById('srcLang'), tgt: document.getElementById('tgtLang'),
        container: document.getElementById('container'), panel1: document.getElementById('panel1'), panel2: document.getElementById('panel2'),
        resizer: document.getElementById('resizer'), layoutBtn: document.getElementById('layoutBtn'), bar: document.getElementById('progressBar'),
        btnStart: document.getElementById('btnStart'), btnStop: document.getElementById('btnStop'),
        fontFam: document.getElementById('fontFamily'), fontSize: document.getElementById('fontSize'), boldBtn: document.getElementById('boldToggle'),
        selBar: document.getElementById('selection-bar'), selBtn: document.getElementById('translateSelBtn')
    };

    let book, spine, currentIdx = 0, isTranslating = false, fb2Sections = [];
    
    // UI HANDLERS
    ui.menuBtn.onclick = () => ui.settings.classList.toggle('open');
    
    ui.fontFam.onchange = () => { document.body.className = document.body.className.replace(/font-\w+/g, ''); if(ui.fontFam.value!=='ui') document.body.classList.add(`font-${ui.fontFam.value}`); };
    ui.fontSize.onchange = () => document.documentElement.style.setProperty('--font-size', ui.fontSize.value);
    ui.boldBtn.onclick = () => { document.body.classList.toggle('font-bold'); ui.boldBtn.classList.toggle('active-state'); ui.boldBtn.style.background = document.body.classList.contains('font-bold') ? '#fff' : '#444'; ui.boldBtn.style.color = document.body.classList.contains('font-bold') ? '#000' : '#fff'; };

    const setStatus = (msg) => ui.status.innerText = msg;
    const showLoad = () => ui.loader.style.display = 'flex';
    const hideLoad = () => ui.loader.style.display = 'none';
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));

    // LAYOUT & RESIZE
    let isVertical = true;
    function updateLayout() {
        if(isVertical) {
            ui.container.style.flexDirection = 'column'; ui.resizer.style.width = '100%'; ui.resizer.style.height = '12px'; ui.resizer.style.cursor = 'row-resize'; ui.layoutBtn.innerText = '‚¨ç';
        } else {
            ui.container.style.flexDirection = 'row'; ui.resizer.style.width = '12px'; ui.resizer.style.height = '100%'; ui.resizer.style.cursor = 'col-resize'; ui.layoutBtn.innerText = '‚¨Ñ';
        }
        ui.panel1.style.flex = '1'; ui.panel2.style.flex = '1';
    }
    ui.layoutBtn.onclick = () => { isVertical = !isVertical; updateLayout(); };

    let isResizing = false;
    const startR = (e) => { isResizing=true; if(e.type==='touchstart')e.preventDefault(); ui.resizer.classList.add('active'); };
    const stopR = () => { isResizing=false; ui.resizer.classList.remove('active'); };
    const doR = (e) => {
        if(!isResizing) return;
        let cy = e.type.startsWith('touch') ? e.touches[0].clientY : e.clientY;
        let cx = e.type.startsWith('touch') ? e.touches[0].clientX : e.clientX;
        const r = ui.container.getBoundingClientRect();
        if(isVertical) { let pct = ((cy - r.top) / r.height) * 100; if(pct>10 && pct<90) { ui.panel1.style.flex = `0 0 ${pct}%`; ui.panel2.style.flex = '1'; }}
        else { let pct = ((cx - r.left) / r.width) * 100; if(pct>10 && pct<90) { ui.panel1.style.flex = `0 0 ${pct}%`; ui.panel2.style.flex = '1'; }}
    };
    ui.resizer.addEventListener('mousedown', startR); document.addEventListener('mouseup', stopR); document.addEventListener('mousemove', doR);
    ui.resizer.addEventListener('touchstart', startR); document.addEventListener('touchend', stopR); document.addEventListener('touchmove', doR);

    // FILE
    ui.file.onclick = () => { ui.file.value = null; };
    ui.file.addEventListener('change', async (e) => {
        const f = e.target.files[0]; if(!f) return;
        ui.settings.classList.remove('open'); setStatus(`Load: ${f.name}`); showLoad(); await sleep(50); 
        try {
            ui.controls.style.display = 'flex'; const n = f.name.toLowerCase();
            if(n.endsWith('.zip')) await loadZip(f); else if(n.endsWith('.fb2')) await loadFb2(f);
            else if(n.endsWith('.epub')) await loadEpub(f); else if(n.endsWith('.pdf')) await loadPdf(f);
            else render(await f.text()); setStatus(f.name);
        } catch(err) { alert(err.message); setStatus("–û—à–∏–±–∫–∞"); } finally { hideLoad(); }
    });

    async function loadZip(f) {
        const z = new JSZip(); const c = await z.loadAsync(f);
        let t=null, n=""; for(let k in c.files){if(k.match(/\.(fb2|epub|txt)$/i) && !c.files[k].dir){t=c.files[k]; n=k.toLowerCase(); break;}}
        if(!t) throw new Error("–ù–µ—Ç –∫–Ω–∏–≥");
        if(n.endsWith('.epub')) await loadEpub(new File([await t.async("blob")], "b.epub"));
        else if(n.endsWith('.fb2')) processFb2(await t.async("string"));
        else render(await t.async("string"));
    }

    async function loadFb2(f) { processFb2(await f.text()); }
    function processFb2(txt) {
        const doc=new DOMParser().parseFromString(txt,"text/xml"); const body=doc.querySelector("body");
        if(!body) throw new Error("Bad FB2"); const secs=Array.from(body.querySelectorAll("section"));
        fb2Sections=[]; ui.chapSel.innerHTML='';
        if(secs.length>0){ secs.forEach((s,i)=>{ let t=s.querySelector("title")?.textContent||`Glava ${i+1}`; if(t.length>20)t=t.substring(0,20)+"..."; fb2Sections.push(s); ui.chapSel.add(new Option(t, i)); }); loadFb2Chap(0); }
        else { fb2Sections=[body]; ui.chapSel.add(new Option("–¢–µ–∫—Å—Ç", 0)); loadFb2Chap(0); }
    }
    function loadFb2Chap(i) { resetTrans(); currentIdx = i; ui.chapSel.value = i; const s = fb2Sections[i]; let txt = ""; const ps = s.querySelectorAll("p,v,subtitle"); if(ps.length>0) ps.forEach(p=>txt+=p.textContent+"\n\n"); else txt = s.textContent; render(txt); }

    async function loadEpub(f) { fb2Sections = []; book = ePub(await f.arrayBuffer()); await book.ready; spine = book.spine.spineItems; ui.chapSel.innerHTML = ''; spine.forEach((_,i) => ui.chapSel.add(new Option(`${i+1}`, i))); loadEpubChap(0); }
    async function loadEpubChap(i) { resetTrans(); currentIdx = i; ui.chapSel.value = i; showLoad(); try { const doc = await spine[i].load(book.load.bind(book)); let h = doc.body?.innerHTML || new XMLSerializer().serializeToString(doc); let t = h.replace(/<(br|div|p|h\d)[^>]*>/gi, '\n').replace(/<[^>]+>/g, '').replace(/&nbsp;/g,' ').replace(/\n\s*\n/g, '\n\n'); render(t); } catch(e) { render("Err: "+e.message); } finally { hideLoad(); } }

    async function loadPdf(f) { ui.controls.style.display = 'none'; showLoad(); try { const pdf = await pdfjsLib.getDocument(await f.arrayBuffer()).promise; let t = ""; for(let i=1; i<=Math.min(pdf.numPages, 30); i++) { const p = await pdf.getPage(i); const c = await p.getTextContent(); t += c.items.map(s=>s.str).join(' ') + "\n\n"; } render(t); } catch(e) { alert("PDF Error"); } finally { hideLoad(); } }

    function render(txt) {
        ui.orig.innerHTML = ''; ui.trans.innerHTML = ''; ui.orig.scrollTop = 0;
        const arr = txt.split(/\n\s*\n/).filter(x => x.trim().length > 1);
        if(!arr.length) { ui.orig.innerHTML = "<p>Empty</p>"; return; }
        const f1 = document.createDocumentFragment(); const f2 = document.createDocumentFragment();
        arr.forEach(s => {
            const d1 = document.createElement('div'); d1.className = 'orig-p'; d1.innerHTML = s.replace(/([a-zA-Z–∞-—è–ê-–Ø0-9\u00C0-\u00FF'-]+)/g, '<span class="word" onclick="clickWord(event,this)">$1</span>'); f1.appendChild(d1);
            const d2 = document.createElement('div'); d2.className = 'trans-p'; d2.dataset.text = s; d2.innerHTML = `<span class="trans-marker">üåé</span>${s}`; d2.onclick = () => doTrans(d2); f2.appendChild(d2);
        });
        ui.orig.appendChild(f1); ui.trans.appendChild(f2); setupSync();
    }

    async function api(txt) {
        const u = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=${ui.src.value}&tl=${ui.tgt.value}&dt=t&q=${encodeURIComponent(txt)}`;
        const r = await fetch(u); const d = await r.json(); return d[0].map(x=>x[0]).join('');
    }

    // --- GOOGLE AUDIO ---
    function playAudio(word) {
        const lang = ui.src.value === 'auto' ? 'en' : ui.src.value;
        const url = `https://translate.google.com/translate_tts?ie=UTF-8&client=tw-ob&tl=${lang}&q=${encodeURIComponent(word)}`;
        const audio = new Audio(url);
        const btn = document.querySelector('.t-tts-btn');
        if(btn) btn.classList.add('playing');
        audio.onended = audio.onerror = () => { if(btn) btn.classList.remove('playing'); };
        audio.play().catch(e => alert("Audio Err"));
    }

    // --- SELECTION ---
    let selText = "";
    document.addEventListener('selectionchange', () => {
        clearTimeout(window.selTimeout);
        window.selTimeout = setTimeout(() => {
            const sel = window.getSelection();
            const txt = sel.toString().trim();
            if(txt && txt.length > 1 && ui.orig.contains(sel.anchorNode)) {
                selText = txt; ui.selBar.classList.add('visible');
            } else { ui.selBar.classList.remove('visible'); }
        }, 300);
    });

    // CHANGE: CLICK instead of MOUSEDOWN
    ui.selBtn.onclick = (e) => { 
        e.preventDefault(); 
        e.stopPropagation();
        if(selText) {
            showPopup(selText, true); 
            ui.selBar.classList.remove('visible'); 
        }
    };

    // --- PHONETICS ---
    async function fetchPhonetics(word) {
        const lang = ui.src.value;
        const w = word.toLowerCase().replace(/[.,!?;:()"]/g, '');
        if(!w) return {ipa:null, cyr:null};
        if(lang === 'en' || lang === 'auto') {
            try { const r = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${w}`); if(r.ok) { const d = await r.json(); const ipa = d[0].phonetic || d[0].phonetics.find(p=>p.text)?.text; const cyr = transliterateEn(w); return { ipa, cyr }; } } catch {}
        }
        if(lang === 'de') return { ipa: germanToIPA(w), cyr: transliterateDe(w) };
        return {ipa:null, cyr:null};
    }

    function germanToIPA(w){let s=w.toLowerCase();s=s.replace(/sch/g,' É').replace(/ch/g,'√ß').replace(/ei/g,'a…™').replace(/ie/g,'iÀê').replace(/eu/g,'…î è').replace(/√§u/g,'…î è').replace(/au/g,'a ä').replace(/√§/g,'…õ').replace(/√∂/g,'√∏').replace(/√º/g,'y').replace(/√ü/g,'s').replace(/j/g,'j').replace(/v/g,'f').replace(/w/g,'v').replace(/z/g,'ts').replace(/sp/g,' Ép').replace(/st/g,' Ét');return `[${s}]`}
    function transliterateDe(w){let s=w.toLowerCase();s=s.replace(/sch/g,'—à').replace(/ch/g,'—Ö').replace(/ei/g,'–∞–π').replace(/ie/g,'i').replace(/eu/g,'–æ–π').replace(/√§u/g,'–æ–π').replace(/au/g,'–∞—É').replace(/√§/g,'—ç').replace(/√∂/g,'—ë').replace(/√º/g,'—é').replace(/√ü/g,'—Å—Å').replace(/j/g,'–π').replace(/v/g,'—Ñ').replace(/w/g,'–≤').replace(/z/g,'—Ü').replace(/sp/g,'—à–ø').replace(/st/g,'—à—Ç').replace(/h/g,'—Ö');return s}
    function transliterateEn(w){const map={'sh':'—à','ch':'—á','th':'–∑','ph':'—Ñ','oo':'—É','ee':'–∏','ea':'–∏','ck':'–∫','qu':'–∫–≤','a':'–∞','b':'–±','c':'–∫','d':'–¥','e':'–µ','f':'—Ñ','g':'–≥','h':'—Ö','i':'–∏','j':'–¥–∂','k':'–∫','l':'–ª','m':'–º','n':'–Ω','o':'–æ','p':'–ø','r':'—Ä','s':'—Å','t':'—Ç','u':'—é','v':'–≤','w':'–≤','x':'–∫—Å','y':'–π','z':'–∑'};let s=w;for(let k in map)s=s.replace(new RegExp(k,'g'),map[k]);return s}

    async function doTrans(el) {
        if(el.classList.contains('translated') || el.classList.contains('loading')) return;
        el.classList.add('loading', 'current');
        try { const t = await api(el.dataset.text); el.innerHTML = t; el.classList.add('translated'); } catch { el.classList.add('error'); } finally { el.classList.remove('loading', 'current'); }
    }

    function resetTrans() { isTranslating=false; ui.btnStart.disabled=false; ui.btnStop.disabled=true; }

    ui.btnStart.onclick = async () => {
        if(isTranslating) return; const els = Array.from(document.querySelectorAll('.trans-p')); if(!els.length) return;
        isTranslating = true; ui.btnStart.disabled = true; ui.btnStop.disabled = false;
        let idx = els.findIndex(e => e.offsetTop + e.clientHeight > ui.trans.scrollTop); if(idx<0) idx=0;
        for(let i=idx; i<els.length; i++) { if(!isTranslating) break; if(!els[i].classList.contains('translated')) { await doTrans(els[i]); ui.bar.style.width = `${((i+1)/els.length)*100}%`; await sleep(500); } }
        ui.bar.style.width = '0%'; resetTrans();
    };
    ui.btnStop.onclick = resetTrans;

    async function showPopup(text, isPhrase) {
        if(!text) return;
        
        ui.tooltip.style.display = 'block';
        if(isPhrase) { 
            ui.tooltip.style.top = '50%'; ui.tooltip.style.left = '50%'; 
            ui.tooltip.style.transform = 'translate(-50%, -50%)'; ui.tooltip.style.maxWidth='80%'; 
        }
        ui.tooltip.innerHTML = `<span class="t-word">${text.substring(0,50)}...</span><span class="t-trans">‚è≥</span>`;
        
        try {
            const promises = [api(text)];
            if(!isPhrase) promises.push(fetchPhonetics(text));
            const [trans, phon] = await Promise.all(promises);
            let ipaHtml='', cyrHtml='';
            if(phon) { ipaHtml = phon.ipa ? `<span class="t-ipa">[${phon.ipa}]</span>` : ''; cyrHtml = phon.cyr ? `<span class="t-rus">"${phon.cyr}"</span>` : ''; }
            
            // Clean quotes and NEWLINES for audio button
            const safeText = text.replace(/'/g, "\\'").replace(/"/g, '&quot;').replace(/\n/g, ' ');

            ui.tooltip.innerHTML = `
                <div class="tt-header">
                    <span class="t-word">${text.substring(0,50)}${text.length>50?'...':''}</span>
                    <button class="t-tts-btn" onclick="playAudio('${safeText}')">üîä</button>
                </div>
                ${ipaHtml} ${cyrHtml}
                <span class="t-trans">${trans}</span>
                <button class="close-tip" onclick="document.getElementById('tooltip').style.display='none'">–ó–∞–∫—Ä—ã—Ç—å</button>`;
        } catch(e) { 
            console.error(e);
            ui.tooltip.innerHTML = "–û—à–∏–±–∫–∞"; 
        }
    }

    window.clickWord = async (e, el) => {
        e.stopPropagation(); document.querySelectorAll('.word.active').forEach(x=>x.classList.remove('active')); el.classList.add('active');
        const rect = el.getBoundingClientRect(); ui.tooltip.style.transform = 'none'; ui.tooltip.style.maxWidth = '250px';
        ui.tooltip.style.top = (rect.bottom + 5) + 'px';
        let left = rect.left; if(left + 250 > window.innerWidth) left = window.innerWidth - 260; ui.tooltip.style.left = left + 'px';
        showPopup(el.innerText, false);
    };

    document.addEventListener('click', (e) => { 
        if(!e.target.closest('.word') && !e.target.closest('#tooltip') && e.target.id !== 'translateSelBtn') { 
            ui.tooltip.style.display = 'none'; document.querySelectorAll('.word.active').forEach(x=>x.classList.remove('active')); 
        }
    });

    let t_sync;
    function setupSync() {
        ui.orig.onscroll = () => { if(t_sync) return; t_sync=requestAnimationFrame(()=>{ s(ui.orig, ui.trans); t_sync=null; }); };
        ui.trans.onscroll = () => { if(t_sync) return; t_sync=requestAnimationFrame(()=>{ s(ui.trans, ui.orig); t_sync=null; }); };
    }
    const s = (a, b) => { b.scrollTop = (a.scrollTop / (a.scrollHeight - a.clientHeight)) * (b.scrollHeight - b.clientHeight); }

    function loadAny(i) { if(fb2Sections.length) loadFb2Chap(i); else if(spine && spine.length) loadEpubChap(i); }
    ui.chapSel.onchange = (e) => loadAny(parseInt(e.target.value));
    document.getElementById('prevBtn').onclick = () => loadAny(currentIdx-1);
    document.getElementById('nextBtn').onclick = () => loadAny(currentIdx+1);

    updateLayout();
</script>
</body>
</html>
